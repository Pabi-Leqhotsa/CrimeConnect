<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cape Town Crime Map</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/feather-icons"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .crime-marker {
      border-radius: 50%;
      border: 2px solid white;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    .stats-card {
      transition: all 0.3s ease;
    }
    .stats-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
  </style>
</head>
<body class="bg-gray-100 p-6">

  <!-- Crime Map -->
  <div class="max-w-6xl mx-auto bg-white p-6 rounded-lg shadow-md">
    <div class="flex items-center justify-between mb-4">
      <h2 class="text-xl font-semibold">Cape Town Crime Map</h2>
      <div class="flex space-x-2">
        <button id="filter-day" class="px-3 py-1 bg-blue-500 text-white rounded-md text-sm filter-btn active">24H</button>
        <button id="filter-week" class="px-3 py-1 bg-gray-100 rounded-md text-sm filter-btn">Week</button>
        <button id="filter-month" class="px-3 py-1 bg-gray-100 rounded-md text-sm filter-btn">Month</button>
      </div>
    </div>

    <!-- Map Filters -->
    <div class="grid grid-cols-4 gap-2 mb-4">
      <button class="crime-filter active px-2 py-1 bg-red-100 text-red-800 text-xs rounded flex items-center justify-center" data-type="all">
        <i data-feather="filter" class="w-3 h-3 mr-1"></i> All
      </button>
      <button class="crime-filter px-2 py-1 bg-orange-100 text-orange-800 text-xs rounded flex items-center justify-center" data-type="theft">
        <i data-feather="shopping-bag" class="w-3 h-3 mr-1"></i> Theft
      </button>
      <button class="crime-filter px-2 py-1 bg-purple-100 text-purple-800 text-xs rounded flex items-center justify-center" data-type="assault">
        <i data-feather="user-x" class="w-3 h-3 mr-1"></i> Assault
      </button>
      <button class="crime-filter px-2 py-1 bg-yellow-100 text-yellow-800 text-xs rounded flex items-center justify-center" data-type="suspicious">
        <i data-feather="eye" class="w-3 h-3 mr-1"></i> Suspicious
      </button>
    </div>

    <!-- ADDED: Live Stats Section -->
    <div class="grid grid-cols-1 lg:grid-cols-4 gap-4 mb-6">
      <div class="stats-card bg-white p-4 rounded-lg shadow-md border-l-4 border-red-500">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-gray-500 text-sm">Active Incidents</p>
            <h3 class="text-2xl font-bold" id="active-incidents">18</h3>
          </div>
          <div class="bg-red-100 p-3 rounded-full">
            <i data-feather="alert-octagon" class="text-red-500 w-5 h-5"></i>
          </div>
        </div>
        <div class="mt-2">
          <span class="text-xs text-red-600 bg-red-100 px-2 py-1 rounded-full">+3 today</span>
        </div>
      </div>
      
      <div class="stats-card bg-white p-4 rounded-lg shadow-md border-l-4 border-green-500">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-gray-500 text-sm">Community Members</p>
            <h3 class="text-2xl font-bold" id="community-members">2,847</h3>
          </div>
          <div class="bg-green-100 p-3 rounded-full">
            <i data-feather="users" class="text-green-500 w-5 h-5"></i>
          </div>
        </div>
        <div class="mt-2">
          <span class="text-xs text-green-600 bg-green-100 px-2 py-1 rounded-full">Active now</span>
        </div>
      </div>
      
      <div class="stats-card bg-white p-4 rounded-lg shadow-md border-l-4 border-yellow-500">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-gray-500 text-sm">Response Time</p>
            <h3 class="text-2xl font-bold" id="response-time">12min</h3>
          </div>
          <div class="bg-yellow-100 p-3 rounded-full">
            <i data-feather="clock" class="text-yellow-500 w-5 h-5"></i>
          </div>
        </div>
        <div class="mt-2">
          <span class="text-xs text-yellow-600 bg-yellow-100 px-2 py-1 rounded-full">Average</span>
        </div>
      </div>
      
      <div class="stats-card bg-white p-4 rounded-lg shadow-md border-l-4 border-blue-500">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-gray-500 text-sm">Safety Score</p>
            <h3 class="text-2xl font-bold" id="safety-score">76%</h3>
          </div>
          <div class="bg-blue-100 p-3 rounded-full">
            <i data-feather="shield" class="text-blue-500 w-5 h-5"></i>
          </div>
        </div>
        <div class="mt-2">
          <span class="text-xs text-blue-600 bg-blue-100 px-2 py-1 rounded-full">Good</span>
        </div>
      </div>
    </div>

    <div id="crime-map" class="w-full rounded" style="height: 500px;"></div>

    <div class="mt-3 flex justify-between items-center text-sm text-gray-600">
      <span id="map-stats">Showing 4 incidents in your area</span>
      <button onclick="refreshMap()" class="text-blue-500 hover:text-blue-700 flex items-center">
        <i data-feather="refresh-cw" class="w-4 h-4 mr-1"></i> Refresh
      </button>
    </div>

    <!-- ADDED: Recent Incidents Section -->
    <div class="mt-6 bg-white p-6 rounded-lg shadow-md">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-semibold">Recent Incidents</h2>
        <span class="text-xs bg-red-100 text-red-800 px-2 py-1 rounded-full" id="incident-count">5 new</span>
      </div>
      <div class="space-y-4 max-h-96 overflow-y-auto pr-2" id="incidents-list">
        <!-- Incidents will be loaded here dynamically -->
      </div>
    </div>

    <!-- ADDED: Quick Actions Section -->
    <div class="mt-6 grid grid-cols-1 lg:grid-cols-2 gap-6">
      <!-- Quick Actions -->
      <div class="bg-white p-6 rounded-lg shadow-md">
        <h2 class="text-xl font-semibold mb-4">Quick Actions</h2>
        <div class="grid grid-cols-2 gap-4">
          <button class="flex items-center justify-center p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors" onclick="location.href='report_crime.html'">
            <div class="bg-blue-100 p-3 rounded-full mr-3">
              <i data-feather="plus" class="text-blue-500 w-5 h-5"></i>
            </div>
            <span>Report Crime</span>
          </button>
          <button class="flex items-center justify-center p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors" onclick="location.href='safety_resources.html'">
            <div class="bg-green-100 p-3 rounded-full mr-3">
              <i data-feather="shield" class="text-green-500 w-5 h-5"></i>
            </div>
            <span>Safety Tips</span>
          </button>
          <button class="flex items-center justify-center p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors" onclick="location.href='community_chat.html'">
            <div class="bg-purple-100 p-3 rounded-full mr-3">
              <i data-feather="message-square" class="text-purple-500 w-5 h-5"></i>
            </div>
            <span>Community Chat</span>
          </button>
          <button class="flex items-center justify-center p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors" onclick="shareLocation()">
            <div class="bg-orange-100 p-3 rounded-full mr-3">
              <i data-feather="map-pin" class="text-orange-500 w-5 h-5"></i>
            </div>
            <span>Share Location</span>
          </button>
        </div>
      </div>

      <!-- Emergency Alerts -->
      <div class="bg-white p-6 rounded-lg shadow-md border-l-4 border-red-500">
        <h2 class="text-xl font-semibold mb-4 text-red-700">Emergency Alerts</h2>
        <div class="space-y-3">
          <div class="p-3 bg-red-50 border border-red-200 rounded-lg">
            <div class="flex items-center justify-between">
              <span class="font-medium text-red-800">Power Outage</span>
              <span class="text-xs text-red-600">1h ago</span>
            </div>
            <p class="text-sm text-red-700 mt-1">Reported in Northern Suburbs. Emergency services deployed.</p>
          </div>
          <div class="p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
            <div class="flex items-center justify-between">
              <span class="font-medium text-yellow-800">Weather Alert</span>
              <span class="text-xs text-yellow-600">3h ago</span>
            </div>
            <p class="text-sm text-yellow-700 mt-1">Strong winds expected in Cape Town area tonight.</p>
          </div>
        </div>
        <button class="w-full mt-4 bg-red-100 text-red-700 py-2 rounded-lg font-medium hover:bg-red-200 transition-colors" onclick="location.href='community_chat.html'"">
          View All Alerts
        </button>
      </div>
    </div>
  </div>

  <script>
    feather.replace();

    const map = L.map('crime-map').setView([-33.9249, 18.4241], 12); // Cape Town
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    const incidents = [
      { type: 'theft', coords: [-33.92, 18.42], label: 'Theft at Long Street', time: '2 hours ago', severity: 'medium' },
      { type: 'assault', coords: [-33.93, 18.43], label: 'Assault near Green Point', time: '4 hours ago', severity: 'high' },
      { type: 'suspicious', coords: [-33.91, 18.41], label: 'Suspicious activity in Sea Point', time: '1 hour ago', severity: 'low' },
      { type: 'theft', coords: [-33.925, 18.426], label: 'Theft at V&A Waterfront', time: '6 hours ago', severity: 'medium' },
      { type: 'assault', coords: [-33.918, 18.431], label: 'Assault reported in CBD', time: '3 hours ago', severity: 'high' },
      { type: 'suspicious', coords: [-33.935, 18.418], label: 'Suspicious vehicle in Observatory', time: '30 minutes ago', severity: 'low' }
    ];

    let markers = [];

    // ADDED: Function to create custom markers
    function createCustomMarker(incident) {
      const colors = {
        theft: 'orange',
        assault: 'purple',
        suspicious: 'yellow'
      };
      
      return L.divIcon({
        className: 'crime-marker',
        html: `<div style="background-color: ${colors[incident.type]}; width: 20px; height: 20px;"></div>`,
        iconSize: [20, 20]
      });
    }

    function renderMarkers(filterType = 'all') {
      markers.forEach(m => map.removeLayer(m));
      markers = [];

      const filtered = filterType === 'all' ? incidents : incidents.filter(i => i.type === filterType);

      filtered.forEach(i => {
        const marker = L.marker(i.coords, { icon: createCustomMarker(i) })
          .addTo(map)
          .bindPopup(`
            <div class="p-2">
              <h3 class="font-bold">${i.label}</h3>
              <p class="text-sm text-gray-600">${i.time}</p>
              <span class="inline-block mt-1 px-2 py-1 text-xs rounded ${
                i.severity === 'high' ? 'bg-red-100 text-red-800' : 
                i.severity === 'medium' ? 'bg-orange-100 text-orange-800' : 
                'bg-yellow-100 text-yellow-800'
              }">
                ${i.severity.toUpperCase()}
              </span>
            </div>
          `);
        markers.push(marker);
      });

      document.getElementById('map-stats').textContent = `Showing ${filtered.length} incidents in your area`;
      updateRecentIncidents(filtered);
    }

    // ADDED: Function to update recent incidents list
    function updateRecentIncidents(filteredIncidents) {
      const incidentsList = document.getElementById('incidents-list');
      incidentsList.innerHTML = '';
      
      filteredIncidents.slice(0, 5).forEach(incident => {
        const incidentItem = document.createElement('div');
        incidentItem.className = 'incident-item p-3 border border-gray-200 rounded-lg';
        incidentItem.innerHTML = `
          <div class="flex justify-between items-start">
            <div>
              <h4 class="font-medium">${incident.label}</h4>
              <p class="text-sm text-gray-600">${incident.time}</p>
            </div>
            <span class="text-xs px-2 py-1 rounded ${
              incident.severity === 'high' ? 'bg-red-100 text-red-800' : 
              incident.severity === 'medium' ? 'bg-orange-100 text-orange-800' : 
              'bg-yellow-100 text-yellow-800'
            }">
              ${incident.severity.toUpperCase()}
            </span>
          </div>
        `;
        incidentsList.appendChild(incidentItem);
      });
      
      document.getElementById('incident-count').textContent = `${filteredIncidents.length} total`;
    }

    renderMarkers();

    document.querySelectorAll('.crime-filter').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.crime-filter').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        renderMarkers(btn.dataset.type);
      });
    });

    function refreshMap() {
      renderMarkers(document.querySelector('.crime-filter.active').dataset.type);
    }

    // ADDED: Time filter functionality
    document.querySelectorAll('.filter-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.filter-btn').forEach(b => {
          b.classList.remove('active', 'bg-blue-500', 'text-white');
          b.classList.add('bg-gray-100');
        });
        btn.classList.add('active', 'bg-blue-500', 'text-white');
        btn.classList.remove('bg-gray-100');
        // Here you would typically filter incidents by time
        // For now, we'll just refresh the current filter
        refreshMap();
      });
    });

    // ADDED: Share location function
    function shareLocation() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(position) {
          alert('Location shared with community safety network');
          // Add a marker for user's location
          const userMarker = L.marker([position.coords.latitude, position.coords.longitude])
            .addTo(map)
            .bindPopup('Your shared location')
            .openPopup();
        }, function(error) {
          alert('Enable location services to share your location');
        });
      } else {
        alert('Geolocation is not supported by this browser');
      }
    }

    // ADDED: Emergency alert function
    function triggerEmergency() {
      if (confirm('Are you sure you want to trigger an emergency alert? This will notify all community members and emergency services.')) {
        alert('Emergency alert sent! Help is on the way.');
        // Here you would typically send the alert to your backend
      }
    }
  </script>
</body>
</html>